{% extends "base.html" %}

{% block main %}
    <div class="banner">
        <h1>–ö–∞—Ç–∞–ª–æ–≥ —Å—Ç—Ä–∞–π–∫–±–æ–ª—å–Ω–æ–≥–æ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è</h1>
        <p>–õ—É—á—à–µ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∏–≥—Ä</p>
    </div>

    <form class="panel-filter" method="GET" id="main-filter">
        <div class="filter-group">
            <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
            <select name="category" id="category">
                <option value="">–í—Å–µ</option>
                <option value="weapon" {% if current_category == 'weapon' %}selected{% endif %}>–û—Ä—É–∂–∏–µ</option>
                <option value="armor" {% if current_category == 'armor' %}selected{% endif %}>–ë—Ä–æ–Ω—è</option>
                <option value="accessory" {% if current_category == 'accessory' %}selected{% endif %}>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</option>
            </select>
        </div>

        {% if current_category == 'weapon' %}
        <div class="filter-group">
            <label for="subcategory">–¢–∏–ø –æ—Ä—É–∂–∏—è:</label>
            <select name="subcategory" id="subcategory">
                <option value="">–í—Å–µ</option>
                <option value="assault" {% if current_subcategory == 'assault' %}selected{% endif %}>–ê–≤—Ç–æ–º–∞—Ç—ã</option>
                <option value="sniper" {% if current_subcategory == 'sniper' %}selected{% endif %}>–°–Ω–∞–π–ø–µ—Ä—Å–∫–∏–µ</option>
                <option value="machinegun" {% if current_subcategory == 'machinegun' %}selected{% endif %}>–ü—É–ª–µ–º—ë—Ç—ã</option>
                <option value="shotgun" {% if current_subcategory == 'shotgun' %}selected{% endif %}>–î—Ä–æ–±–æ–≤–∏–∫–∏</option>
                <option value="pistol" {% if current_subcategory == 'pistol' %}selected{% endif %}>–ü–∏—Å—Ç–æ–ª–µ—Ç—ã</option>
                <option value="melee" {% if current_subcategory == 'melee' %}selected{% endif %}>–•–æ–ª–æ–¥–Ω–æ–µ –æ—Ä—É–∂–∏–µ</option>
            </select>
        </div>
        {% endif %}
    </form>

    <div class="category-filter">
        <button class="category-btn" data-category="all">–í—Å–µ</button>
        {% if current_category == 'weapon' or not current_category %}
        <button class="category-btn" data-category="weapon" data-subcategory="assault">–ê–≤—Ç–æ–º–∞—Ç—ã</button>
        <button class="category-btn" data-category="weapon" data-subcategory="sniper">–°–Ω–∞–π–ø–µ—Ä—Å–∫–∏–µ</button>
        <button class="category-btn" data-category="weapon" data-subcategory="machinegun">–ü—É–ª–µ–º—ë—Ç—ã</button>
        <button class="category-btn" data-category="weapon" data-subcategory="shotgun">–î—Ä–æ–±–æ–≤–∏–∫–∏</button>
        <button class="category-btn" data-category="weapon" data-subcategory="pistol">–ü–∏—Å—Ç–æ–ª–µ—Ç—ã</button>
        <button class="category-btn" data-category="weapon" data-subcategory="melee">–•–æ–ª–æ–¥–Ω–æ–µ</button>
        {% endif %}
        <button class="category-btn" data-category="armor">–ë—Ä–æ–Ω—è</button>
        <button class="category-btn" data-category="accessory">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
    </div>

    <!-- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div class="products-grid">
        {% for item in items %}
        <div class="product-card" data-category="{{ item.category }}">
            {% if item.cover %}
            <img src="{{ item.cover.url }}" alt="{{ item.name }}" class="product-image">
            {% endif %}
            <h3>{{ item.name }}</h3>
            <p class="price">{{ item.price }} —Ä—É–±.</p>
            <p class="description">{{ item.description|truncatechars:100 }}</p>
            <button class="add-to-cart" data-item-id="{{ item.id }}">
    –í –∫–æ—Ä–∑–∏–Ω—É
    <span class="cart-icon">üõí</span>
</button>
        </div>
        {% empty %}
        <p class="no-items">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        {% endfor %}
    </div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const category = this.dataset.category;
                const subcategory = this.dataset.subcategory;
                const mainForm = document.getElementById('main-filter');
                
                if (category === 'all') {
                    mainForm.querySelector('#category').value = '';
                    if (mainForm.querySelector('#subcategory')) {
                        mainForm.querySelector('#subcategory').value = '';
                    }
                } else {
                    mainForm.querySelector('#category').value = category;
                    if (subcategory && mainForm.querySelector('#subcategory')) {
                        mainForm.querySelector('#subcategory').value = subcategory;
                    }
                }
                
                mainForm.submit();
            });
        });

        document.querySelector('#category').addEventListener('change', function() {
            const subcategorySelect = document.querySelector('#subcategory');
            if (subcategorySelect) {
                if (this.value === 'weapon') {
                    subcategorySelect.style.display = 'block';
                } else {
                    subcategorySelect.style.display = 'none';
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const categorySelect = document.querySelector('#category');
            const subcategorySelect = document.querySelector('#subcategory');
            
            if (categorySelect && subcategorySelect) {
                if (categorySelect.value !== 'weapon') {
                    subcategorySelect.style.display = 'none';
                }
            }
        });
    </script>
        <script>
$(document).ready(function() {
        $('.add-to-cart').click(function() {
        const itemId = $(this).data('item-id');
        const button = $(this);
        
        $.ajax({
            url: "{% url 'add_to_cart' 0 %}".replace('0', itemId),
            method: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification(response.message);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã
                    $('.cart-count').text(response.cart_count);
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
                    button.addClass('added');
                    setTimeout(function() {
                        button.removeClass('added');
                    }, 1000);
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
                showNotification(error, 'error');
            }
        });
    });
    
    function showNotification(message, type = 'success') {
        const notification = $('<div class="notification ' + type + '">' + message + '</div>');
        $('body').append(notification);
        notification.fadeIn();
        setTimeout(function() {
            notification.fadeOut(function() {
                $(this).remove();
            });
        }, 3000);
    }
});

    </script>
{% endblock %}